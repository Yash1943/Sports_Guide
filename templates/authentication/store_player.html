{% extends 'authentication/base.html' %} {% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div id="alertContainer"></div>
      <div class="card">
        <div class="card-header">
          <h3 class="text-center">Add Player Data</h3>
        </div>
        <div class="card-body">
          <form id="playerForm" method="POST">
            {% csrf_token %}
            <div class="form-group mb-3">
              <label for="name">Player Name</label>
              <input type="text" class="form-control" id="name" name="name" required />
            </div>
            <div class="form-group mb-3">
              <label for="role">Role</label>
              <select class="form-control" id="role" name="role" required>
                <option value="Batsman">Batsman</option>
                <option value="Bowler">Bowler</option>
                <option value="All-Rounder">All-Rounder</option>
                <option value="Wicket Keeper">Wicket Keeper</option>
              </select>
            </div>
            <div class="form-group mb-3">
              <label for="batting_average">Batting Average</label>
              <input
                type="number"
                step="0.01"
                class="form-control"
                id="batting_average"
                name="batting_average"
                value="0.0" />
            </div>
            <div class="form-group mb-3">
              <label for="strike_rate">Strike Rate</label>
              <input
                type="number"
                step="0.01"
                class="form-control"
                id="strike_rate"
                name="strike_rate"
                value="0.0" />
            </div>
            <div class="form-group mb-3">
              <label for="total_runs">Total Runs</label>
              <input
                type="number"
                class="form-control"
                id="total_runs"
                name="total_runs"
                value="0" />
            </div>
            <div class="form-group mb-3">
              <label for="wickets">Wickets</label>
              <input type="number" class="form-control" id="wickets" name="wickets" value="0" />
            </div>
            <div class="form-group mb-3">
              <label for="bowling_average">Bowling Average</label>
              <input
                type="number"
                step="0.01"
                class="form-control"
                id="bowling_average"
                name="bowling_average"
                value="0.0" />
            </div>
            <div class="form-group mb-3">
              <label for="economy">Economy</label>
              <input
                type="number"
                step="0.01"
                class="form-control"
                id="economy"
                name="economy"
                value="0.0" />
            </div>
            <div class="form-group mb-3">
              <label for="matches_played">Matches Played</label>
              <input
                type="number"
                class="form-control"
                id="matches_played"
                name="matches_played"
                value="0" />
            </div>
            <div class="form-group mb-3">
              <label for="highest_score">Highest Score</label>
              <input
                type="number"
                class="form-control"
                id="highest_score"
                name="highest_score"
                value="0" />
            </div>
            <div class="form-group mb-3">
              <label for="best_bowling_figures">Best Bowling Figures</label>
              <input
                type="text"
                class="form-control"
                id="best_bowling_figures"
                name="best_bowling_figures"
                value="" />
            </div>
            <div class="text-center">
              <button type="submit" class="btn btn-primary">Save Player Data</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function showAlert(message, type = "danger") {
    const alertContainer = document.getElementById("alertContainer");
    const alert = document.createElement("div");
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    alertContainer.innerHTML = "";
    alertContainer.appendChild(alert);
  }

  document.getElementById("playerForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => {
      if (key !== "csrfmiddlewaretoken") {
        // Convert numeric strings to numbers
        if (!isNaN(value) && value !== "" && key !== "role") {
          data[key] = Number(value);
        } else {
          data[key] = value;
        }
      }
    });

    // Show loading state
    const submitButton = this.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = "Saving...";

    fetch("/api/store-player/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
      },
      body: JSON.stringify(data),
    })
      .then(async (response) => {
        const responseData = await response.json();
        if (!response.ok) {
          throw new Error(responseData.message || "Network response was not ok");
        }
        return responseData;
      })
      .then((data) => {
        showAlert("Player data stored successfully!", "success");
        this.reset();
      })
      .catch((error) => {
        console.error("Error:", error);
        showAlert(error.message || "Error storing player data. Please try again.");
      })
      .finally(() => {
        // Reset button state
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
      });
  });
</script>
{% endblock %}
